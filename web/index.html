<!DOCTYPE html>
<html lang="en" class="sl-theme-dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qpyt-UI Framework</title>

    <!-- Shoelace Theme & Assets -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/themes/dark.css" />
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/shoelace-autoloader.js"></script>

    <script type="module">
        import { setBasePath } from 'https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/utilities/base-path.js';
        setBasePath('https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/');
    </script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bg-color: #020617;
        }

        body {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        header {
            padding: 2rem;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            margin: 0;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .workflow-area {
            display: flex;
            padding: 2rem;
            gap: 1rem;
            overflow-x: auto;
            align-items: flex-start;
            flex-grow: 1;
            scrollbar-width: thin;
            scrollbar-color: #334155 transparent;
        }

        .workflow-area::-webkit-scrollbar {
            height: 6px;
        }

        .workflow-area::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        #autoloader-trigger {
            display: none;
        }
    </style>
</head>

<body>
    <header>
        <h1 id="app-title">Qpyt-UI V0.9.9 TURBO</h1>
        <div style="color: #64748b; font-size: 0.9rem;">Quantum Pixel Yield Terminal - Keep it smart, keep it visual.
        </div>
    </header>

    <div class="workflow-area" id="main-workflow">
        <!-- Dynamically filled by Python via app.js -->
    </div>

    <!-- Global Configuration Interface -->
    <sl-button id="workflow-trigger" circle size="large" title="Workflows & Presets"
        style="position: fixed; bottom: 30px; left: 95px; z-index: 9999;">
        <sl-icon name="save"></sl-icon>
    </sl-button>

    <sl-button id="settings-trigger" circle size="large" title="Settings"
        style="position: fixed; bottom: 30px; left: 160px; z-index: 9999;">
        <sl-icon name="gear"></sl-icon>
    </sl-button>

    <!-- Drawer: Workflow Manager -->
    <sl-drawer id="workflow-drawer" label="Workflow Manager" style="--size: 400px;">
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <p style="color: #64748b; font-size: 0.9rem; margin-top: 0;">Save your current brick layout as a workflow.
            </p>

            <div
                style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <sl-input id="wf-save-name" placeholder="Workflow name (e.g. My Anime Style)"></sl-input>
                <sl-button id="wf-save-btn" variant="primary" style="width: 100%; margin-top: 0.8rem;">
                    <sl-icon slot="prefix" name="download"></sl-icon>
                    Save Workflow
                </sl-button>
            </div>

            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                <sl-tab-group>
                    <sl-tab slot="nav" panel="my-workflows">My Workflows</sl-tab>
                    <sl-tab slot="nav" panel="presets">Factory Presets</sl-tab>

                    <sl-tab-panel name="my-workflows">
                        <div id="workflow-list"
                            style="display: flex; flex-direction: column; gap: 0.5rem; padding-top: 1rem;">
                            <p style="color: #475569; font-style: italic; font-size: 0.8rem;">Loading...</p>
                        </div>
                    </sl-tab-panel>
                    <sl-tab-panel name="presets">
                        <div id="preset-list"
                            style="display: flex; flex-direction: column; gap: 0.5rem; padding-top: 1rem;">
                            <p style="color: #475569; font-style: italic; font-size: 0.8rem;">Loading...</p>
                        </div>
                    </sl-tab-panel>
                </sl-tab-group>
            </div>
        </div>
    </sl-drawer>

    <sl-drawer id="settings-drawer" label="Qpyt-UI Configuration" style="--size: 500px;">
        <sl-tab-group>
            <sl-tab slot="nav" panel="basic">Basic Settings</sl-tab>
            <sl-tab slot="nav" panel="advanced">Advanced (JSON)</sl-tab>

            <sl-tab-panel name="basic">
                <div id="settings-form" style="display: flex; flex-direction: column; gap: 1.2rem; padding-top: 1rem;">
                    <p style="color: #64748b; font-size: 0.85rem; margin-top: 0;">Paths for model scanning and image
                        outputs.</p>

                    <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                        <sl-input id="cfg-models-dir" label="SDXL Models Folder"
                            help-text="Main models/checkpoints folder" style="flex: 1;"></sl-input>
                        <sl-button id="btn-scan-sdxl" size="small" variant="neutral" outline
                            title="Scan this folder for models">Scan</sl-button>
                    </div>

                    <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                        <sl-input id="cfg-flux-models-dir" label="FLUX Models Folder"
                            help-text="Main models/flux folder" style="flex: 1;"></sl-input>
                        <sl-button id="btn-scan-flux" size="small" variant="neutral" outline
                            title="Scan this folder for models">Scan</sl-button>
                    </div>

                    <sl-input id="cfg-loras-dir" label="LoRAs Folder"></sl-input>
                    <sl-input id="cfg-output-dir" label="Outputs Folder (Images)"></sl-input>

                    <div
                        style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.5rem; padding-top: 1rem; display: flex; flex-direction: column; gap: 1rem;">
                        <p style="color: #64748b; font-size: 0.85rem; margin-top: 0;">Default models to load on startup.
                        </p>

                        <sl-select id="cfg-default-model" label="Default SDXL Model" help-text="Used by SDXL bricks"
                            clearable></sl-select>
                        <sl-select id="cfg-default-flux-model" label="Default Flux Model"
                            help-text="Used by Flux bricks" clearable></sl-select>
                    </div>

                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <sl-button id="cfg-save-btn" variant="primary" style="width: 100%;">Save All
                            Settings</sl-button>
                    </div>
                </div>
            </sl-tab-panel>

            <sl-tab-panel name="advanced">
                <div style="display: flex; flex-direction: column; gap: 1rem; padding-top: 1rem; height: 100%;">
                    <p style="color: #64748b; font-size: 0.85rem; margin-top: 0;">Raw <code>config.local.json</code>
                        editor. Be careful with syntax.</p>
                    <sl-textarea id="cfg-json-editor" resize="auto" rows="20"
                        style="font-family: monospace; font-size: 0.8rem;"></sl-textarea>

                    <sl-button id="cfg-json-save-btn" variant="primary" outline style="width: 100%;">Save JSON
                        Changes</sl-button>
                </div>
            </sl-tab-panel>
        </sl-tab-group>
    </sl-drawer>

    <!-- For√ßage de l'autoloader -->
    <div id="autoloader-trigger">
        <sl-drawer></sl-drawer><sl-button></sl-button><sl-icon></sl-icon>
        <sl-textarea></sl-textarea><sl-input></sl-input><sl-spinner></sl-spinner>
        <sl-dialog></sl-dialog><sl-alert></sl-alert>
        <sl-select></sl-select><sl-option></sl-option>
    </div>

    <qp-dashboard></qp-dashboard>
    <qp-library></qp-library>

    <!-- External Libraries -->
    <script src="/static/js/imagetracer.js"></script>

    <!-- Framework Scripts -->
    <script type="module" src="/static/components/qp-cartridge.js?v=41"></script>
    <script type="module" src="/static/components/qp-bricks.js?v=45"></script>
    <script type="module" src="/static/components/qp-filter.js?v=45"></script>
    <script type="module" src="/static/components/qp-dashboard.js?v=45"></script>
    <script type="module" src="/static/components/qp-library.js?v=45"></script>
    <script type="module" src="/static/components/qp-lora-manager.js?v=42"></script>
    <script type="module" src="/static/components/qp-queue-monitor.js?v=42"></script>
    <script type="module" src="/static/components/qp-monitor.js?v=42"></script>
    <script type="module" src="/static/components/qp-depth-estimator.js?v=42"></script>
    <script type="module" src="/static/components/qp-normal-map.js?v=42"></script>
    <script type="module" src="/static/components/qp-music-gen.js?v=42"></script>
    <script type="module" src="/static/components/qp-openpose-editor.js?v=42"></script>
    <script type="module" src="/static/components/qp-canvas.js?v=42"></script>
    <script type="module" src="/static/components/qp-sprite.js?v=44"></script>
    <script type="module" src="/static/components/qp-batch-runner.js?v=44"></script>
    <script type="module" src="/static/components/qp-civitai.js?v=44"></script>
    <script type="module" src="/static/components/qp-image-blender.js?v=45"></script>
    <script type="module" src="/static/app.js?v=44"></script>

    <!-- Hot Reload Script -->
    <script>
        (function () {
            let socket;
            let reconnectInterval = 2000;

            function connect() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/hot-reload`;
                socket = new WebSocket(wsUrl);

                socket.onmessage = (event) => {
                    if (event.data === 'reload') {
                        console.log('üîÑ Hot Reload triggered...');
                        window.location.reload();
                    }
                };

                socket.onclose = () => {
                    console.log('üì° Hot reload disconnected. Retrying in ' + reconnectInterval + 'ms...');
                    setTimeout(connect, reconnectInterval);
                };

                socket.onerror = (err) => {
                    console.error('‚ùå Hot reload socket error:', err);
                    socket.close();
                };
            }

            connect();
            console.log('üöÄ Hot reload active.');
        })();
    </script>
</body>

</html>